# This README is for training purposes only and is to be used only
# in support of approved training. The author assumes no liability
# for use outside of a training environments. Unless required by
# applicable law or agreed to in writing, software distributed under
# the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
# OR CONDITIONS OF ANY KIND, either express or implied.

# Title: 4-hdp-tls.txt 
# Author: WKD
# Date: 200530

Note: This work was built on scripts provided by Cloudera PS. They have been modified for classroom purposes.

Note: You must generate the required certs and load them into hdp-tls/auth directory before you begin.

EDIT THE CONFIGS FILE
1. Edit the config file to add the domain and certificate info.

	% cd hdp-tls
	% vim configs 

2. Copy the configs file into ambari-tls. Ensure these are both in sync.

	% cp configs ../ambari-tls/

GENERATE CA CERTS
IMPORTANT: This task needs to be done once on the admin node. This does not need to be repeated on every host. This task will copy over a domain signed certificate signing request (cer) in to the ca directory. It will also copy over a domain signing keys into the keys directory. The name of these files are:

	cloudair.lan.crt
	cloudair.lan.key
	cloudair.lan.der

1. Generate the cert files.

	% sudo ./generate-hdp-tls.sh GenerateCACert configs

PREPARE TO GENERATE-HDP-TLS
1. Go to the directory for ssl.

	% cd ~/sbin/tls

2. Create a tar file.

	% tar -cvf /tmp/hdp-tls.tar hdp-tls

PUSH AND EXTRACT THE TAR FILE TO ALL NODES
1. Push the tar file to all hosts

	% run-remote-file.sh push /tmp/hdp-tls.tar /tmp

2. Extract the tar file on all hosts 

	% run-remote-file.sh extract /tmp/hdp-tls.tar  /tmp

3. Clean up the tar file on all hosts

	% run-remote-file.sh delete /tmp/hdp-tls.tar

RUN GENERATE-TLS ON ALL NODES
IMPORTANT: The setup-hdp-tls.sh has a DIR variable set to /tmp/hdp-tls. The
script expects to find the generate file in this directory.

1. Run the install command on all hosts

	% run-remote-file.sh run /tmp/hdp-tls/setup-hdp-tls.sh

2. The setup-hdp-tls.sh will run the generate-hdp-tls.sh with the options:

	GenerateKeys
	GenerateTruststore
	GenerateRanger
	GenerateJCEKS
	
VALIDATE GENERATE-TLS
1. Check various nodes the certs and keys. Check the following directories:

	% ls /etc/security/keystores/
		creds.jceks  ranger-plugin.jks	server.jks
	% ls /etc/security/truststores/
		ranger-truststore.jks truststore.jks
	% ls /etc/security/pki/
		server.crt server.key server.p12

ROLLBACK GENERATE-TLS
1. If you need to rollback on all hosts you must run the rollback script. This is important to do as the cacerts keystore has been updated with the generate script. This will set this file back to the original state.

	% run-remote-files.sh run /tmp/hdp-tls/rollback-hdp-tls.sh

2. You can then run the setup-hdp-tls.sh script again.
